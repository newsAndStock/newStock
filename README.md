# ğŸ“ˆ newStock ğŸ“‰
**ë‰´ìŠ¤**ì™€ **ëª¨ì˜íˆ¬ì**ë¥¼ í†µí•œ ê²½ì œ êµìœ¡ ì•±

## ğŸ“… í”„ë¡œì íŠ¸ ì†Œê°œ
**ì‚¼ì„± ì²­ë…„ SW ì•„ì¹´ë°ë¯¸ 11th íŠ¹í™”í”„ë¡œì íŠ¸ ìš°ìˆ˜ìƒ**ğŸ†

###  í”„ë¡œì íŠ¸ ê°œë°œ ê¸°ê°„
2024.08.26 ~ 2024.10.11 (7ì£¼)

###   ê¸°íš ë°°ê²½
- **ê²½ì œ ë¬¸ë§¹**ì´ë¼ëŠ” ì‹ ì¡°ì–´ë„ ìƒê¸¸ë§Œí¼ ë¬¸ì œ ì‹¬ê°
- ëŒ€í•œë¯¼êµ­ êµ­ë¯¼ ê²½ì œ ì´í•´ë ¥ í‰ê·  56.3ì , **ê¸ˆìœµ ë¬¸ë§¹ë¥  67%**
- ì£¼ì‹ ì‹œì¥ê³¼ ê²½ì œ ë‰´ìŠ¤ì˜ ê´€ê³„ë¥¼ ì‰½ê²Œ í•™ìŠµí•  ìˆ˜ ìˆëŠ” ë„êµ¬ì˜ í•„ìš”ì„± ì¦ê°€
###  ëª©í‘œ
- ì‚¬ìš©ìë“¤ì´ ê²½ì œ íë¦„ì„ íŒŒì•…í•˜ê³  íˆ¬ì ì˜ì‚¬ ê²°ì •ì„ ì—°ìŠµí•˜ë©°, ê¸ˆìœµ ì§€ì‹ì„ ìì—°ìŠ¤ëŸ½ê²Œ ìŒ“ì„ ìˆ˜ ìˆë„ë¡ ì§€ì›
- ì£¼ì‹ ì‹œì¥ê³¼ ê²½ì œ ë‰´ìŠ¤ì˜ ê´€ê³„ë¥¼ ì‰½ê²Œ í•™ìŠµí•  ìˆ˜ ìˆëŠ” ë„êµ¬ ì œê³µ
- ê²½ì œ ë¬¸ë§¹ì„ ì¤„ì´ê¸° ìœ„í•´, ì‹¤ì‹œê°„ ê²½ì œ ë‰´ìŠ¤ë¥¼ í™œìš©í•œ **ëª¨ì˜ ì£¼ì‹ íˆ¬ì í•™ìŠµ í”Œë«í¼** ì œê³µ

## ğŸš€ ê¸°ëŠ¥ ì†Œê°œ
### ì£¼ì‹ í˜ì´ì§€
<img src="asset/buy.gif" height="500"/> <img src="asset/selll.gif"  height="500"/> <img src="asset/graph.gif" height="500"/></br>
<img src="asset/stock_main.gif" height="500"/> <img src="asset/mypage.gif"  height="500"/> </br>
- ì‹¤ì œ ì£¼ì‹ ì‹œì¥ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ëª¨ì˜ íˆ¬ì ê¸°ëŠ¥
- **ìš°ì„ ìˆœìœ„ í** ë° ìŠ¤ì¼€ì¤„ë§ì„ í†µí•œ íˆ¬ì ê´€ë¦¬ ê¸°ëŠ¥

### ë‰´ìŠ¤ í˜ì´ì§€
<img src="asset/news_main.gif" height="500"/> <img src="asset/search_scrap.gif"  height="500"/></br>
- ìµœì‹  ê²½ì œ ë‰´ìŠ¤ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì œê³µ
- **Spark**ë¥¼ í™œìš©í•œ ë‰´ìŠ¤ ë³¸ë¬¸ ê²½ì œ ë‹¨ì–´ ì¶”ì¶œ í…ìŠ¤íŠ¸ ë§ˆì´ë‹ ë¶„ì‚°ì²˜ë¦¬(1master, 2worker)
- **Querydsl**ì„ ì‚¬ìš©í•˜ì—¬ ë¹ ë¥¸ ê²€ìƒ‰ ì§€ì›
- ë‰´ìŠ¤ ìŠ¤í¬ë© ê¸°ëŠ¥

### í€´ì¦ˆ í˜ì´ì§€
<img src="asset/quiz.gif" height="500"/> </br>
- ê¸ˆìœµìš©ì–´ 700ì„ ê³¼ í•œêµ­ ìƒì¥ ì£¼ì‹ íšŒì‚¬ ê´€ë ¨ í€´ì¦ˆ ì œê³µ
- ê¸ˆìœµ ì§€ì‹ê³¼ ê²½ì œ ì´í•´ë„ í–¥ìƒì— ê¸°ì—¬

### ì¶œì„ í˜ì´ì§€
<img src="asset/roulette.gif" height="500"/> </br>
- ì¶œì„ ì²´í¬ ë° ì‚¬ìš©ì ì°¸ì—¬ë„ í–¥ìƒ ê¸°ëŠ¥

### íšŒì› ê°€ì… ë° ë¡œê·¸ì¸
<img src="asset/enroll.gif" height="500"/>  <img src="asset/login.gif"  height="500"/> 
## ğŸ’š ê¸°ëŒ€ íš¨ê³¼
- ê²½ì œ êµìœ¡ ê°•í™”
- íˆ¬ì ìŠ¤í‚¬ í–¥ìƒ
- ê²½ì œ ì´í•´ë„ ì¦ì§„
- íˆ¬ì ê´€ì‹¬ ìœ ë„ ë° í™œì„±í™”

## ğŸ—ï¸ ì„¤ê³„
###  ì™€ì´ì–´ í”„ë ˆì„
<img src="asset/figma.PNG" width="800" height="350"/></br>

###  ì‹œìŠ¤í…œ ì•„í‚¤í…ì³
<img src="asset/architecture.PNG" width="800" height="350"/></br>

### ERD
<img src="asset/erd.PNG" width="800" height="350"/></br>

###  API ëª…ì„¸ì„œ
<img src="asset/api1.PNG" width="800" height="350"/></br>

## ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ

**FE Development**

<img src="https://img.shields.io/badge/flutter-02569B?style=for-the-badge&logo=flutter&logoColor=white"> <img src="https://img.shields.io/badge/dart-0175C2?style=for-the-badge&logo=dart&logoColor=white"> <img src="https://img.shields.io/badge/CSS3-1572B6?style=for-the-badge&logo=CSS3&logoColor=white"> 

**BE Development**

<img src="https://img.shields.io/badge/springboot-6DB33F?style=for-the-badge&logo=springboot&logoColor=white"> <img src="https://img.shields.io/badge/JAVA-007396?style=for-the-badge&logo=OpenJDK&logoColor=white">  <img src="https://img.shields.io/badge/JPA%20(Hibernate)-00485B?style=for-the-badge&logo=Hibernate&logoColor=white"> <img src="https://img.shields.io/badge/jwt-000000?style=for-the-badge&logo=json-web-tokens&logoColor=white"> 

**Database**

  <img src="https://img.shields.io/badge/mariadb-4479A1?style=for-the-badge&logo=mariadb&logoColor=white"> <img src="https://img.shields.io/badge/Amazon RDS-527FFF?style=for-the-badge&logo=amazon rds&logoColor=white"> <img src="https://img.shields.io/badge/flyway-CC0200?style=for-the-badge&logo=flyway&logoColor=white"> <img src="https://img.shields.io/badge/redis-FF4438?style=for-the-badge&logo=redis&logoColor=white">


**Data Distributed Processing**

<img src="https://img.shields.io/badge/python-3776AB?style=for-the-badge&logo=python&logoColor=white"> <img src="https://img.shields.io/badge/Selenium-43B02A?style=for-the-badge&logo=Selenium&logoColor=white"> <img src="https://img.shields.io/badge/awslambda-FF9900?style=for-the-badge&logo=awslambda&logoColor=white"> <img src="https://img.shields.io/badge/Amazon%20S3-569A31?style=for-the-badge&logo=Amazon%20S3&logoColor=white"> <img src="https://img.shields.io/badge/apachespark-E25A1C?style=for-the-badge&logo=apachespark&logoColor=white"> 


**Infra**

<img src="https://img.shields.io/badge/ubuntu-E95420?style=for-the-badge&logo=ubuntu&logoColor=white"> <img src="https://img.shields.io/badge/amazon%20ec2-FF9900?style=for-the-badge&logo=amazon-ec2&logoColor=white"> <img src="https://img.shields.io/badge/nginx-009639?style=for-the-badge&logo=nginx&logoColor=white"> <img src="https://img.shields.io/badge/amazonaws-232F3E?style=for-the-badge&logo=amazonwebservices&logoColor=white">

**CI/CD**

<img src="https://img.shields.io/badge/gitlab-FC6D26?style=for-the-badge&logo=gitlab&logoColor=white"> <img src="https://img.shields.io/badge/jenkins-D24939?style=for-the-badge&logo=jenkins&logoColor=white"> <img src="https://img.shields.io/badge/docker-2496ED?style=for-the-badge&logo=docker&logoColor=white">

**SUPPORT TOOL**

<img src="https://img.shields.io/badge/git-F05032?style=for-the-badge&logo=git&logoColor=white"> <img src="https://img.shields.io/badge/postman-FF6C37?style=for-the-badge&logo=postman&logoColor=white"> <img src="https://img.shields.io/badge/jira-0052CC?style=for-the-badge&logo=jira&logoColor=white"> <img src="https://img.shields.io/badge/notion-000000?style=for-the-badge&logo=notion&logoColor=white"> <img src="https://img.shields.io/badge/intellij%20idea-000000?style=for-the-badge&logo=intellij-idea&logoColor=white"> <img src="https://img.shields.io/badge/visual%20studio%20code-007ACC?style=for-the-badge&logo=visual-studio-code&logoColor=white"> <img src="https://img.shields.io/badge/jupyter-F37626?style=for-the-badge&logo=jupyter&logoColor=white"> <img src="https://img.shields.io/badge/mattermost-0058CC?style=for-the-badge&logo=mattermost&logoColor=white"> <img src="https://img.shields.io/badge/swagger-85EA2D?style=for-the-badge&logo=swagger&logoColor=white"> <img src="https://img.shields.io/badge/datagrip-000000?style=for-the-badge&logo=datagrip&logoColor=white"> <img src="https://img.shields.io/badge/androidstudio-3DDC84?style=for-the-badge&logo=androidstudio&logoColor=white">



## ğŸ‘¥ íŒ€ì› ì†Œê°œ
<table>
<tr>
    <td align="center"><a href="https://github.com/boeunyoon"><b>ğŸ‘‘ìœ¤ë³´ì€</b></a></td>
    <td align="center"><a href="https://github.com/Do1K"><b>ê°•ë„ì›</b></a></td>
    <td align="center"><a href="https://github.com/kimsw0516"><b>ê¹€ì„±ì›</b></a></td>
    <td align="center"><a href="https://github.com/zhzzang"><b>ì´ì£¼í¬</b></a></td>
    <td align="center"><a href="https://github.com/aswe0409"><b>ì •ì„ì˜</b></a></td>
    <td align="center"><a href="https://github.com/stopvvon"><b>ì •ì§€ì›</b></a></td>
  </tr>
 <tr>
    <td align="center"><a href="https://github.com/boeunyoon"><img src="https://avatars.githubusercontent.com/boeunyoon" width="130px;" alt=""></a></td>
       <td align="center"><a href="https://github.com/Do1K"><img src="https://avatars.githubusercontent.com/Do1K" width="130px;" alt=""></a></td>
    <td align="center"><a href="https://github.com/kimsw0516"><img src="https://avatars.githubusercontent.com/seungminleeee" width="130px;" alt=""></a></td>
    <td align="center"><a href="https://github.com/zhzzang"><img src="https://avatars.githubusercontent.com/zhzzang" width="130px;" alt=""></a></td>
    <td align="center"><a href="https://github.com/aswe0409"><img src="https://avatars.githubusercontent.com/aswe0409" width="130px;" alt=""></a></td>
    <td align="center"><a href="https://github.com/stopvvon"><img src="https://avatars.githubusercontent.com/stopvvon" width="130px;" alt=""></a></td>

  </tr>
  <tr>
    <td align="center"><b>FE & BE</b></a></td>
    <td align="center"><b>BE & INFRA</b></a></td>
    <td align="center"><b>FE</b></a></td>
    <td align="center"><b>BE</b></a></td>
    <td align="center"><b>DATA & BE</b></a></td>
    <td align="center"><b>FE</b></a></td>
  </tr>
</table>

</br>
</br>

# ğŸ”¥ ë‚˜ì˜ ê¸°ì—¬


# 1ï¸âƒ£ ì‹¤ì‹œê°„ ì£¼ì‹ ì²´ê²° ë°ì´í„°ë¥¼ í™œìš©í•œ ë¹„ë™ê¸° ëª¨ì˜ ê±°ë˜ ì‹œìŠ¤í…œ

> ğŸ’¡ ê°œìš”
> 
> 
> í•œêµ­íˆ¬ìì¦ê¶Œ APIì—ì„œ ì œê³µí•˜ëŠ” ì‹¤ì‹œê°„ ì£¼ì‹ ì²´ê²° ë°ì´í„°(WebSocket)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, ì‚¬ìš©ìì˜ **ì§€ì •ê°€ ì£¼ë¬¸ì„ ë¹„ë™ê¸°ì ìœ¼ë¡œ ì²˜ë¦¬**í•˜ëŠ” ëª¨ì˜ ê±°ë˜ ì‹œìŠ¤í…œì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ìš”ì²­ì— ì¦‰ê°ì ìœ¼ë¡œ ì‘ë‹µí•˜ë©´ì„œë„, ë°±ê·¸ë¼ìš´ë“œì—ì„œëŠ” ìˆ˜ë§ì€ ê±°ë˜ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ ì„¤ê³„í–ˆìŠµë‹ˆë‹¤.
> 

<br/>

## ğŸ¯ í•µì‹¬ ì„¤ê³„ ëª©í‘œ ë° ê³ ë ¤ì‚¬í•­

### 1. ë¹„ë™ê¸°/ë…¼ë¸”ë¡œí‚¹ ì²˜ë¦¬ë¥¼ í†µí•œ ì‚¬ìš©ì ê²½í—˜ ê·¹ëŒ€í™”

ì‚¬ìš©ìê°€ ì§€ì •ê°€ ì£¼ë¬¸ì„ ìš”ì²­í–ˆì„ ë•Œ, ì‹¤ì œ ì²´ê²°ì´ ì´ë£¨ì–´ì§ˆ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê²Œ í•  ìˆ˜ëŠ” ì—†ìŠµë‹ˆë‹¤. `CompletableFuture.runAsync`ë¥¼ ì ê·¹ì ìœ¼ë¡œ í™œìš©í•˜ì—¬ ì£¼ë¬¸ ì ‘ìˆ˜ì™€ ì‹¤ì œ ì²´ê²° ë¡œì§ì„ ë¶„ë¦¬í–ˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì‚¬ìš©ìëŠ” **ì£¼ë¬¸ ìš”ì²­ ì¦‰ì‹œ 'ì ‘ìˆ˜ ì™„ë£Œ' ì‘ë‹µ**ì„ ë°›ì„ ìˆ˜ ìˆìœ¼ë©°, ì‹œìŠ¤í…œì€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ íš¨ìœ¨ì ìœ¼ë¡œ ê±°ë˜ë¥¼ ì²˜ë¦¬í•˜ëŠ” **ë¹„ë™ê¸°-ë…¼ë¸”ë¡œí‚¹ ëª¨ë¸**ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

### 2. ë™ì‹œì„± ì œì–´ë¥¼ í†µí•œ ë°ì´í„° ì •í•©ì„± í™•ë³´

ì—¬ëŸ¬ ì‚¬ìš©ìì˜ ì£¼ë¬¸ì´ í•˜ë‚˜ì˜ ì¢…ëª©ì— ëª°ë¦´ ê²½ìš°, ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ê³µìœ  ìì›(ì£¼ë¬¸ ëŒ€ê¸°ì—´)ì— ë™ì‹œì— ì ‘ê·¼í•˜ì—¬ **ë ˆì´ìŠ¤ ì»¨ë””ì…˜(Race Condition)**ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `synchronized` í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•´ **ì„ê³„ ì˜ì—­(Critical Section)**ì„ ì„¤ì •í•¨ìœ¼ë¡œì¨, 'ì£¼ë¬¸ í™•ì¸ í›„ ì²˜ë¦¬' ë¡œì§ì´ ì›ìì (Atomic)ìœ¼ë¡œ ì‹¤í–‰ë˜ë„ë¡ ë³´ì¥í•˜ì—¬ ë°ì´í„° ì •í•©ì„±ì„ í™•ë³´í–ˆìŠµë‹ˆë‹¤.

### 3. ìƒíƒœ ë¶„ë¦¬ë¥¼ í†µí•œ íš¨ìœ¨ì ì¸ ì‹¤ì‹œê°„ ì²˜ë¦¬

ì£¼ë¬¸ ì·¨ì†Œ ìš”ì²­ì´ ì™”ì„ ë•Œ, ë§¤ë²ˆ DBì— ì·¨ì†Œ ì—¬ë¶€ë¥¼ ì¡°íšŒí•˜ëŠ” ê²ƒì€ ì‹¤ì‹œê°„ ì²˜ë¦¬ ë£¨í”„ì— í° ë¶€ë‹´ì„ ì¤ë‹ˆë‹¤. **DBì˜ ìƒíƒœ**ì™€ **ë©”ëª¨ë¦¬ì˜ ì‹¤ì‹œê°„ ìƒíƒœ í”Œë˜ê·¸**(`Set<Long>`)ë¥¼ ì´ì›í™”í•˜ì—¬, ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬ ì¤‘ì—ëŠ” ë©”ëª¨ë¦¬ì—ì„œ ë§¤ìš° ë¹ ë¥¸ ì†ë„ë¡œ ì·¨ì†Œ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³ , ìµœì¢… ì²˜ë¦¬ ì‹œì ì—ë§Œ DB ìƒíƒœë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì—¬ ì¼ê´€ì„±ì„ ë§ì¶”ëŠ” ì˜ë¦¬í•œ ë°©ì‹ì„ ì±„íƒí–ˆìŠµë‹ˆë‹¤.

---

## ğŸ“‰ ì‹œì¥ê°€ ì£¼ë¬¸ ì²´ê²° íë¦„

ê°€ì¥ ê°„ë‹¨í•œ íë¦„ì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ 'ì‹œì¥ê°€'ë¡œ ì£¼ë¬¸í•˜ë©´, ì‹œìŠ¤í…œì€ í˜„ì¬ ê°€ê²©ìœ¼ë¡œ ì¦‰ì‹œ ê±°ë˜ë¥¼ ì²´ê²°ì‹œí‚µë‹ˆë‹¤.

1. **ìš”ì²­ ì ‘ìˆ˜ (`TradingService`)**: ì»¨íŠ¸ë¡¤ëŸ¬ê°€ `sellByMarket` ë˜ëŠ” `buyByMarket` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
2. **í˜„ì¬ê°€ ì¡°íšŒ**: `kisService`ë¥¼ í†µí•´ í•´ë‹¹ ì¢…ëª©ì˜ í˜„ì¬ ì‹œì¥ê°€ë¥¼ ì¦‰ì‹œ ì¡°íšŒí•©ë‹ˆë‹¤.
3. **ê±°ë˜ ì™„ë£Œ ì²˜ë¦¬**: ì¡°íšŒëœ ì‹œì¥ê°€ë¡œ ê±°ë˜ë¥¼ ë°”ë¡œ ì™„ë£Œ ì²˜ë¦¬í•˜ê³ , `Trading` ì—”í‹°í‹°ì— ì™„ë£Œ ì‹œê°„ì„ ê¸°ë¡í•©ë‹ˆë‹¤.
4. **ìì‚° ë³€ê²½**: `MemberStocksService`ì™€ `MemberService`ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‚¬ìš©ìì˜ ì£¼ì‹ ë³´ìœ ëŸ‰ê³¼ ì˜ˆìˆ˜ê¸ˆì„ ì¦‰ì‹œ ë³€ê²½í•©ë‹ˆë‹¤.
5. **DB ì €ì¥ ë° ì•Œë¦¼**: ì™„ë£Œëœ ê±°ë˜ ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ê³ , ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ì„ ë³´ë‚¸ ë’¤ íë¦„ì´ ì¢…ë£Œë©ë‹ˆë‹¤.

> â–¶ï¸ ê´€ë ¨ ì½”ë“œ ë³´ê¸° (TradingService.java)
> 

```java
@Transactional
    public TradeResponse sellByMarket(Member member, TradeRequest sellRequest) {

        sellPossible(member, sellRequest);
        Trading trading = sellRequest.toEntity(member, OrderType.SELL, TradeType.MARKET);
        // 1. í˜„ì¬ê°€ ì¡°íšŒ
        trading.confirmBid(getStockPrPr(sellRequest.getStockCode()));
        // 2. ì¦‰ì‹œ ì™„ë£Œ ì²˜ë¦¬
        trading.tradeComplete(LocalDateTime.now());
        // 3. ì‚¬ìš©ì ìì‚° ë³€ê²½
        memberStocksService.sellComplete(member.getId(),sellRequest.getStockCode(),sellRequest.getQuantity(),trading.getBid());
        memberService.updateDeposit(member.getId(),(long)(trading.getBid() * trading.getQuantity()),OrderType.SELL);
        // 4. DB ì €ì¥
        tradingRepository.save(trading);

        CompletableFuture<Void> future=sendTradeMessage(member.getId(),sellRequest.getStockCode(), (long) sellRequest.getQuantity(),OrderType.SELL,trading.getBid());

        return new TradeResponse(OrderType.SELL, trading.getBid(), trading.getOrderCompleteTime(), trading.getQuantity(), trading.getBid() * trading.getQuantity());
    }
```

## ğŸ“ˆ ì§€ì •ê°€ ì£¼ë¬¸ ì²´ê²° íë¦„

ì§€ì •ê°€ ì£¼ë¬¸ì€ **[ì ‘ìˆ˜] â†’ [ëŒ€ê¸°] â†’ [ì‹¤ì‹œê°„ ë§¤ì¹­] â†’ [ìµœì¢… ì²˜ë¦¬]**ì˜ 4ë‹¨ê³„ ë¹„ë™ê¸° íŒŒì´í”„ë¼ì¸ì„ í†µí•´ ì²˜ë¦¬ë©ë‹ˆë‹¤.

`ì‚¬ìš©ì` â†’ `TradingService (ì£¼ë¬¸ ì ‘ìˆ˜)` â†’ `TradeQueue (ì£¼ë¬¸ ëŒ€ê¸°)` â†’ `KisServiceSocket (ì‹¤ì‹œê°„ ë§¤ì¹­)` â†’ `TradingService (ìµœì¢… ì²˜ë¦¬)`

### 1ë‹¨ê³„: ì£¼ë¬¸ ì ‘ìˆ˜ ë° ë¹„ë™ê¸° ì²˜ë¦¬ ì‹œì‘

`TradingService`ëŠ” ì‚¬ìš©ìì˜ ì§€ì •ê°€ ì£¼ë¬¸ì„ ë°›ì•„ DBì— 'ë¯¸ì²´ê²°' ìƒíƒœë¡œ ê¸°ë¡í•˜ê³ , ë©”ëª¨ë¦¬ì— ìˆëŠ” `TradeQueue`ì— ì£¼ë¬¸ì„ ì¶”ê°€í•©ë‹ˆë‹¤. ì´í›„ `CompletableFuture`ë¥¼ í†µí•´ KIS ì„œë²„ì— í•´ë‹¹ ì¢…ëª©ì˜ ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹ ì„ ìš”ì²­í•˜ëŠ” ì‘ì—…ì„ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œë¡œ ìœ„ì„í•˜ê³ , ì¦‰ì‹œ ì‚¬ìš©ìì—ê²Œ ì‘ë‹µí•©ë‹ˆë‹¤.

> â–¶ï¸ ê´€ë ¨ ì½”ë“œ ë³´ê¸° (TradingService.java)
> 

```java
@Transactional
public void buyByLimit(Member member, TradeRequest buyRequest) throws JsonProcessingException {
    if(!buyPossible(member,buyRequest)){
        throw new IllegalArgumentException("Buy not possible(Insufficient account balance)");
    }
    // 1. 'ë¯¸ì²´ê²°' ìƒíƒœì˜ ê±°ë˜ë¥¼ DBì— ê¸°ë¡
		Trading trading = buyRequest.toEntity(member, OrderType.BUY, TradeType.LIMIT);
		tradingRepository.save(trading);
		memberService.updateDeposit(member.getId(), (long) trading.getBid() * trading.getQuantity(), OrderType.BUY);
		
		
		// 2. ë©”ëª¨ë¦¬ ëŒ€ê¸°ì—´(Queue)ì— ì£¼ë¬¸ ì¶”ê°€
		TradeItem tradeItem = new TradeItem(member, trading.getBid(), trading.getQuantity(), remain, trading.getOrderTime(), trading);
		tradeQueue.addBuy(buyRequest.getStockCode(), tradeItem);
		
		
		// 3. ì‹¤ì‹œê°„ ë°ì´í„° êµ¬ë… ìš”ì²­ì„ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œì— ìœ„ì„
		processWebSocket(buyRequest.getStockCode());
		
}
		 
		
private CompletableFuture processWebSocket(String stockCode) {
			return CompletableFuture.runAsync(() -> {
			kisServiceSocket.sendMessage(stockCode, "1");
	});
}
		
```

> 
> 

### 2ë‹¨ê³„: ë™ì‹œì„±ì„ ê³ ë ¤í•œ ê±°ë˜ ì²´ê²°

`KisServiceSocket`ì€ ì‹¤ì‹œê°„ ì²´ê²° ë°ì´í„°ë¥¼ ìˆ˜ì‹ í•˜ë©´, `TradeQueue`ì—ì„œ ëŒ€ê¸° ì¤‘ì¸ ì£¼ë¬¸ê³¼ ê°€ê²©ì„ ë¹„êµí•©ë‹ˆë‹¤. ì´ë•Œ, ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— íì— ì ‘ê·¼í•˜ëŠ” ê²ƒì„ ë§‰ê¸° ìœ„í•´ **íë¥¼ ì¡°ì‘í•˜ëŠ” í•µì‹¬ ë¡œì§ë§Œ `synchronized` ë¸”ë¡ìœ¼ë¡œ ê°ì‹¸** ì ê¸ˆì„ ìµœì†Œí™”í•˜ê³  ì²˜ë¦¬ íš¨ìœ¨ì„ ë†’ì˜€ìŠµë‹ˆë‹¤.

> â–¶ï¸ ê´€ë ¨ ì½”ë“œ ë³´ê¸° (KisServiceSocket.javaì˜ sellTrade ë©”ì„œë“œ)
> 

```java
private void sellTrade(SocketItem socketItem, String stockCode, Queue<TradeItem> sellItems){
        TradeItem complete = null;
				
				// íë¥¼ ì§ì ‘ ì¡°ì‘í•˜ëŠ” ë¶€ë¶„ë§Œ ì ê·¼ë‹¤ (Lock ìµœì†Œí™”)
        synchronized (sellItems) {
            if (sellItems.isEmpty()) return;

            while (!sellItems.isEmpty() && tradingHandleService.isCanceled(sellItems.peek().getTrading().getId())) {
                TradeItem removed = sellItems.poll();
                tradingHandleService.cancelComplete(removed.getTrading().getId());
                log.info("<{}> [{}]ë‹˜ ë§¤ìˆ˜ê±°ë˜ì·¨ì†Œ", stockCode, removed.getMember().getNickname());
            }

            if (sellItems.isEmpty()) return;

            if (socketItem.getPrice() >= sellItems.peek().getBid()) {
                if (socketItem.getPrice() == sellItems.peek().getBid()) {
                    sellItems.peek().trade(socketItem.getMount());
                } else {
                    sellItems.peek().complete();
                }

                if (sellItems.peek().getRemaining() > 0) return;
								// íì—ì„œ ì•„ì´í…œì„ ë¹¼ë‚´ëŠ” ê²ƒê¹Œì§€ë§Œ synchronized ë¸”ë¡ ì•ˆì—ì„œ ìˆ˜í–‰
                complete = sellItems.poll();
            }
        }// âœ¨ ì—¬ê¸°ì„œ ì ê¸ˆì´ í’€ë¦°ë‹¤!

				// ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¬ëŠ” DB ì‘ì—… ë“±ì€ ì ê¸ˆì´ í’€ë¦° í›„ì— ìˆ˜í–‰
        if (complete != null) {
            sellComplete(stockCode, complete);
            log.info("<{}> [{}]ë‹˜ ë§¤ë„ê±°ë˜ì™„ë£Œ", stockCode, complete.getMember().getNickname());
        }
    }
```

> 
> 

### 3ë‹¨ê³„: ìµœì¢… ì²˜ë¦¬ ë° ìƒíƒœ ì—…ë°ì´íŠ¸

ê±°ë˜ê°€ ì²´ê²°ë˜ë©´, **ë³„ë„ì˜ `TradingService` Bean**ì— êµ¬í˜„ëœ `@Transactional` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ìµœì¢… ì²˜ë¦¬ë¥¼ ìœ„ì„í•©ë‹ˆë‹¤. ì´ëŠ” Spring AOP í”„ë¡ì‹œê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ë„ë¡ í•˜ì—¬ íŠ¸ëœì­ì…˜ì˜ ì›ìì„±ì„ ë³´ì¥í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤. ì´ ë©”ì„œë“œ ì•ˆì—ì„œ **'ì´ë¯¸ ì·¨ì†Œëœ ê±°ë˜ì¸ì§€'** ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•˜ëŠ” ë°©ì–´ ë¡œì§ì„ ì¶”ê°€í•˜ì—¬ ë ˆì´ìŠ¤ ì»¨ë””ì…˜ì„ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤.

> â–¶ï¸ ê´€ë ¨ ì½”ë“œ ë³´ê¸° (TradingService.javaì˜ finalizeSellTrade ë©”ì„œë“œ)
> 

```java
@Transactional
    public void finalizeSellTrade(TradeItem complete, String stockCode) {
        Trading trading = tradingRepository.findById(complete.getTrading().getId())
                .orElseThrow(() -> new IllegalArgumentException("ê±°ë˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));

				// ìµœì¢… ì»¤ë°‹ ì§ì „, DBì—ì„œ ì§ì ‘ ìƒíƒœë¥¼ í™•ì¸í•˜ì—¬ ë ˆì´ìŠ¤ ì»¨ë””ì…˜ ë°©ì§€
        if (trading.isCanceled()) {
            log.warn("ì´ë¯¸ ì·¨ì†Œëœ ê±°ë˜(ID: {})ì— ëŒ€í•œ ì²´ê²° ì‹œë„ê°€ ê°ì§€ë˜ì–´ ì¤‘ë‹¨í•©ë‹ˆë‹¤.", trading.getId());
            return;
        }
				
				// DBë¥¼ ë³€ê²½í•˜ëŠ” ëª¨ë“  ë¡œì§ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ìŒ
        memberStocksService.sellComplete(complete.getMember().getId(),stockCode,complete.getQuantity(),complete.getBid());
        memberService.updateDeposit(complete.getMember().getId(), (long) (complete.getQuantity()*complete.getBid()), OrderType.SELL);
        trading.tradeComplete(LocalDateTime.now());
        notificationService.send(complete.getMember().getId(),stockCode, (long) complete.getQuantity(),OrderType.SELL,complete.getBid());
    }
```

---

## ğŸ—‘ï¸ ì£¼ë¬¸ ì·¨ì†Œ íë¦„

ì£¼ë¬¸ ì·¨ì†ŒëŠ” '**ì¦‰ê°ì ì¸ DB ìƒíƒœ ë³€ê²½**'ê³¼ '**ë©”ëª¨ë¦¬ í”Œë˜ê·¸ë¥¼ í†µí•œ ë¹ ë¥¸ í™•ì¸**'ì´ë¼ëŠ” ì´ì›í™”ëœ ì „ëµì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

### 1ë‹¨ê³„: ì¦‰ê°ì ì¸ ì·¨ì†Œ ì²˜ë¦¬ ë° ìƒíƒœ í”Œë˜ê·¸ ì„¤ì •

ì‚¬ìš©ìê°€ ì·¨ì†Œë¥¼ ìš”ì²­í•˜ë©´ `TradingHandleService`ëŠ” ì¦‰ì‹œ DBì˜ ê±°ë˜ ìƒíƒœë¥¼ `canceled=true`ë¡œ ë³€ê²½í•˜ê³ , ë™ì‹œì— ë©”ëª¨ë¦¬ì— ìˆëŠ” `canceledTrading` Setì— í•´ë‹¹ ê±°ë˜ IDë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.

> â–¶ï¸ ê´€ë ¨ ì½”ë“œ ë³´ê¸° (TradingHandleService.java)
> 

```java
private final Set<Long> canceledTrading= Collections.synchronizedSet(new HashSet<>());
```

```java
@Transactional
    public void removeTrading(Long tradingId, Long memberId) {
		    
		    // 1. ë©”ëª¨ë¦¬ì˜ Setì— ì·¨ì†Œ í”Œë˜ê·¸ ì¶”ê°€
        canceledTrading.add(tradingId);
        
        // 2. DBì˜ ê±°ë˜ ìƒíƒœë¥¼ ì¦‰ì‹œ 'ì·¨ì†Œ'ë¡œ ë³€ê²½í•˜ê³  í™˜ë¶ˆ ì²˜ë¦¬
        Trading trading=tradingRepository.findById(tradingId).get();
        if(!trading.getMember().getId().equals(memberId)){
            throw new AuthenticationCredentialsNotFoundException("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
        }
        if(trading.getOrderType().equals(OrderType.BUY)){
            memberService.updateDeposit(memberId, (long) trading.getBid(),OrderType.SELL);
        }
        trading.cancelTrading();
        tradingRepository.save(trading);

    }
```

### 2ë‹¨ê³„: ë°±ê·¸ë¼ìš´ë“œì—ì„œì˜ ì·¨ì†Œ í™•ì¸ ë° ì •ë¦¬

`KisServiceSocket`ì˜ ê±°ë˜ ì²˜ë¦¬ ë£¨í”„ëŠ” DBì— ë§¤ë²ˆ ì ‘ê·¼í•˜ëŠ” ëŒ€ì‹ , ë©”ëª¨ë¦¬ì˜ `canceledTrading` Setì„ í†µí•´ ë§¤ìš° ë¹ ë¥´ê²Œ ì·¨ì†Œ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³  í•´ë‹¹ ì£¼ë¬¸ì„ ëŒ€ê¸°ì—´ì—ì„œ ì œê±°í•©ë‹ˆë‹¤.

> â–¶ï¸ ê´€ë ¨ ì½”ë“œ ë³´ê¸° (KisServiceSocket.javaì˜ sellTrade ë©”ì„œë“œ ì¼ë¶€)
> 
> 
> ```java
> synchronized (sellItems) {
>     // ...
>     // ë©”ëª¨ë¦¬ Setì„ í†µí•´ ë§¤ìš° ë¹ ë¥¸ ì†ë„ë¡œ ì·¨ì†Œ ì—¬ë¶€ í™•ì¸
>     while (!sellItems.isEmpty() && tradingHandleService.isCanceled(sellItems.peek().getTrading().getId())) {
>         TradeItem removed = sellItems.poll();
>         tradingHandleService.cancelComplete(removed.getTrading().getId());
>         log.info("<{}> [{}]ë‹˜ ë§¤ìˆ˜ê±°ë˜ì·¨ì†Œ", stockCode, removed.getMember().getNickname());
>     }
>     // ...
> }
> ```
> 

---

## ğŸ’¡ íšŒê³  ë° ê°œì„  ë°©í–¥

- **ë°°ìš´ ì **: ì´ë²ˆ í”„ë¡œì íŠ¸ë¥¼ í†µí•´ Springì˜ `@Transactional` ë™ì‘ ì›ë¦¬(AOP í”„ë¡ì‹œ)ì™€ `synchronized`ë¥¼ ì´ìš©í•œ ì •êµí•œ ë™ì‹œì„± ì œì–´, ê·¸ë¦¬ê³  `CompletableFuture`ë¥¼ í™œìš©í•œ ë¹„ë™ê¸°-ë…¼ë¸”ë¡œí‚¹ ì„¤ê³„ì˜ ì¤‘ìš”ì„±ì„ ê¹Šì´ ì´í•´í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.
- **ê°œì„  ë°©í–¥**: í˜„ì¬ ì•„í‚¤í…ì²˜ëŠ” ë‹¨ì¼ ì„œë²„ í™˜ê²½ì„ ê°€ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì„œë²„ë¥¼ 2ëŒ€ ì´ìƒìœ¼ë¡œ í™•ì¥(Scale-out)í•  ê²½ìš°, ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ëŠ” `TradeQueue`ì™€ `canceledTrading` Setì˜ ìƒíƒœ ë¶ˆì¼ì¹˜ ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ **Redisì˜ Sorted Set**ì„ ì¤‘ì•™ ë°ì´í„° ì €ì¥ì†Œë¡œ ë„ì…í•˜ì—¬ ëª¨ë“  ì„œë²„ê°€ ìƒíƒœë¥¼ ê³µìœ í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì•„í‚¤í…ì²˜ë¥¼ ê°œì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

# 2ï¸âƒ£ Redis Sorted Setì„ í™œìš©í•œ ì‹¤ì‹œê°„ ì£¼ì‹ ìˆ˜ìµë¥  ë­í‚¹ ì‹œìŠ¤í…œ

> ğŸ’¡  ê°œìš”
> 
> 
> ì‹¤ì‹œê°„ìœ¼ë¡œ ë³€ë™í•˜ëŠ” ì£¼ì‹ ì‹œì„¸ë¥¼ ë°˜ì˜í•˜ì—¬, ëª¨ë“  ì‚¬ìš©ìì˜ ìˆ˜ìµë¥ (ROI) ìˆœìœ„ë¥¼ ì§‘ê³„í•˜ëŠ” ë­í‚¹ ì‹œìŠ¤í…œì…ë‹ˆë‹¤. **Redisì˜ Sorted Set**ì„ í•µì‹¬ ë°ì´í„° êµ¬ì¡°ë¡œ ì‚¬ìš©í•˜ì—¬ ëŒ€ê·œëª¨ ì‚¬ìš©ì í™˜ê²½ì—ì„œë„ **ë¹ ë¥¸ ì‘ë‹µ ì†ë„ë¥¼ ë³´ì¥**í•˜ë„ë¡ ì„¤ê³„í–ˆìœ¼ë©°, **ì£¼ê¸°ì ì¸ ìŠ¤ì¼€ì¤„ë§**ê³¼ **API í˜¸ì¶œ ìµœì í™”**ë¥¼ í†µí•´ íš¨ìœ¨ì ìœ¼ë¡œ ìµœì‹  ë­í‚¹ì„ ìœ ì§€í•©ë‹ˆë‹¤.
> 

<br/>

## ğŸ¯ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ë° í•µì‹¬ ì„¤ê³„

ë³¸ ë­í‚¹ ì‹œìŠ¤í…œì€ **`Application Server`** - **`Redis`** - **`External API`** 3-Tier êµ¬ì¡°ë¡œ ë™ì‘í•©ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ë­í‚¹ ì¡°íšŒ ìš”ì²­ì€ DB ë¶€í•˜ ì—†ì´ Redisì—ì„œ ì¦‰ì‹œ ì²˜ë¦¬ë˜ë©°, ë¬´ê±°ìš´ ë­í‚¹ ì—°ì‚°ì€ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ í†µí•´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì£¼ê¸°ì ìœ¼ë¡œ ìˆ˜í–‰ë©ë‹ˆë‹¤.

- **Redis í™œìš©**: ë­í‚¹ ë°ì´í„°ì˜ ì €ì¥ ë° ì¡°íšŒë¥¼ ìœ„í•´ In-Memory ì €ì¥ì†Œì¸ Redisë¥¼ ì±„íƒí–ˆìŠµë‹ˆë‹¤. íŠ¹íˆ ìˆœìœ„ ì§‘ê³„ì— ìµœì í™”ëœ **Sorted Set(ZSET)** ìë£Œêµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³µì¡í•œ ë­í‚¹ ë¡œì§ì„ íš¨ìœ¨ì ìœ¼ë¡œ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.
- **API í˜¸ì¶œ ìµœì í™”**: ë­í‚¹ ì§‘ê³„ ì‹œ ìˆ˜ì²œ ë²ˆ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì™¸ë¶€ API í˜¸ì¶œì„, í•„ìš”í•œ ëª¨ë“  ì£¼ì‹ ì •ë³´ë¥¼ **ë¯¸ë¦¬ ìˆ˜ì§‘(Batch)í•˜ê³  ìºì‹±(Caching)**í•˜ì—¬ ë‹¨ ëª‡ì‹­ ë²ˆì˜ í˜¸ì¶œë¡œ ìµœì†Œí™”í–ˆìŠµë‹ˆë‹¤.
- **ì •êµí•œ ë™ì ì ì²˜ë¦¬**: ìˆ˜ìµë¥ ì´ ì†Œìˆ˜ì ê¹Œì§€ ë™ì¼í•œ ê²½ìš°, ê°™ì€ ë“±ìˆ˜ë¥¼ ë¶€ì—¬í•˜ëŠ” **'í‘œì¤€ ê²½ìŸ ìˆœìœ„(Standard Competition Ranking)'** ë¡œì§ì„ êµ¬í˜„í•˜ì—¬ ë­í‚¹ì˜ ì •í™•ì„±ì„ ë†’ì˜€ìŠµë‹ˆë‹¤.

---

## ğŸ“ˆ ë­í‚¹ ì§‘ê³„ íë¦„ (Scheduled Task)

ë­í‚¹ ì§‘ê³„ëŠ” `@Scheduled`ì— ì˜í•´ ì¥ì¤‘ì— ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ë˜ë©°, **[1ë‹¨ê³„: API í˜¸ì¶œ ìµœì í™” ë° ROI ê³„ì‚°]** -> **[2ë‹¨ê³„: ë™ì ì ì²˜ë¦¬ ë° ìˆœìœ„ ë¶€ì—¬]** ì˜ 2ë‹¨ê³„ íŒŒì´í”„ë¼ì¸ìœ¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.

### 1ë‹¨ê³„: API í˜¸ì¶œ ìµœì í™” ë° ROI ê³„ì‚° (`makeRank`)

ê°€ì¥ í° ì„±ëŠ¥ ë³‘ëª©ì´ì—ˆë˜ ì™¸ë¶€ API í˜¸ì¶œì„ ìµœì†Œí™”í•˜ëŠ” ë° ì§‘ì¤‘í–ˆìŠµë‹ˆë‹¤. ëª¨ë“  íšŒì›ì´ ë³´ìœ í•œ ì£¼ì‹ ëª©ë¡ì„ ë¨¼ì € ì·¨í•©í•˜ì—¬, í•„ìš”í•œ í˜„ì¬ê°€ ì •ë³´ë¥¼ **ë‹¨ í•œë²ˆì˜ ë£¨í”„**ë¡œ ì¡°íšŒ ë° ìºì‹±í•œ í›„, ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ëª¨ë“  íšŒì›ì˜ ìˆ˜ìµë¥ ì„ ë¹ ë¥´ê²Œ ê³„ì‚°í•©ë‹ˆë‹¤.

> â–¶ï¸ ê¸°ì¡´ ì½”ë“œ
> 

```java
public void makeRank(){
        ...
        for(Member member:members){
            if(memberStocksService.getMemberStocks(member.getId()).isEmpty())continue;
            double ROI=memberROI(member.getId());
            redisService.addMemberRank(member.getId(),ROI);
        }
        ...
    }
        
        
private double memberROI(Long memberId){
        ...
        for(MemberStock memberStock:memberStocks){
            String stockCode=memberStock.getStockCode();
            int currentPrice=Integer.parseInt(kisService.getCurrentStockPrice(stockCode));
            newPrice+=currentPrice*memberStock.getHoldings();
            oldPrice+=memberStock.getAveragePrice()*memberStock.getHoldings();
        }
				...
    }
```

> â–¶ï¸ ê°œì„ ëœ ì½”ë“œ (RankService.java)
> 

```java
public void makeRank(){
        List<Member> members=memberService.findAllMember();
        redisTemplateRank.delete("memberRank");

        // 1. í•„ìš”í•œ ëª¨ë“  ì£¼ì‹ ì½”ë“œë¥¼ ìˆ˜ì§‘ (ì¤‘ë³µ ì œê±°)
        Set<String> allStockCodes = members.stream()
                .flatMap(member -> memberStocksService.findByMember_Id(member.getId()).stream())
                .map(MemberStock::getStockCode)
                .collect(Collectors.toSet());

        // 2. ê° ì£¼ì‹ì˜ í˜„ì¬ê°€ë¥¼ í•œë²ˆì”©ë§Œ ì¡°íšŒí•˜ì—¬ ìºì‹±
        Map<String, Integer> currentPriceCache = new HashMap<>();
        for (String stockCode : allStockCodes) {
            try {
                currentPriceCache.put(stockCode, Integer.parseInt(kisService.getCurrentStockPrice(stockCode)));
            } catch (NumberFormatException e) {
                currentPriceCache.put(stockCode, 0);
            }
        }
				
				//3. ìºì‹±ëœ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ê° ë©¤ë²„ì˜  ROIë¥¼ ê³„ì‚°
        for(Member member:members){
            if(memberStocksService.getMemberStocks(member.getId()).isEmpty())continue;
            double ROI=memberROI(member.getId(),currentPriceCache);
            redisService.addMemberRank(member.getId(),ROI);
        }
        redisService.setRankTime();
    }
```

### 2ë‹¨ê³„: ë™ì ì ì²˜ë¦¬ ë° ìˆœìœ„ ë¶€ì—¬ (`dealSameScore`)

1ë‹¨ê³„ì—ì„œ ê³„ì‚°ëœ ìˆ˜ìµë¥ (Score)ì„ ê¸°ë°˜ìœ¼ë¡œ, ë™ì¼í•œ ì ìˆ˜ë¥¼ ê°€ì§„ ì‚¬ìš©ìë“¤ì—ê²Œ ê°™ì€ ë“±ìˆ˜ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤. `Map<Double, Integer>`ë¥¼ ì‚¬ìš©í•˜ì—¬ ê° ì ìˆ˜ë³„ ì¸ì›ìˆ˜ë¥¼ ì¹´ìš´íŠ¸í•˜ê³ , ëˆ„ì  ì¸ì›ì„ ë°”íƒ•ìœ¼ë¡œ ì‹¤ì œ ë“±ìˆ˜ë¥¼ ê³„ì‚°í•˜ì—¬ ë³„ë„ì˜ Sorted Set(`memberScore`)ì— ì €ì¥í•©ë‹ˆë‹¤.

> â–¶ï¸ ê´€ë ¨ ì½”ë“œ ë³´ê¸° (RankService.java)
> 

```java
public void dealSameScore(){
        redisTemplateRank.delete("memberScore");
        // 1. `memberRank`ì—ì„œ ëª¨ë“  ë©¤ë²„ì˜ ìˆ˜ìµë¥  ì ìˆ˜ë¥¼ ê°€ì ¸ì˜´
        Map<Long,Double> ranks=redisService.getAllMembersWithScores();
        // 2. ê° ìˆ˜ìµë¥  ì ìˆ˜ë³„ë¡œ ëª‡ ëª…ì˜ ë©¤ë²„ê°€ ìˆëŠ”ì§€ ì¹´ìš´íŠ¸
        Map<Double,Integer> scores=new LinkedHashMap<>();
        for(Map.Entry<Long,Double> entry:ranks.entrySet()){
            scores.put(entry.getValue(),scores.getOrDefault(entry.getValue(),0) + 1);
        }
        // 3. ëˆ„ì  ì¸ì›ì„ ê¸°ë°˜ìœ¼ë¡œ ì‹¤ì œ ë“±ìˆ˜ë¥¼ ê³„ì‚°
        int start=1;
        for(Map.Entry<Double,Integer> entry:scores.entrySet()){
            redisService.addMemberScore(entry.getKey(),start);
            start+=entry.getValue();
        }
    }
```

---

## ğŸ“Š ë­í‚¹ ì¡°íšŒ íë¦„ (API Endpoint)

ì‚¬ìš©ìê°€ ë­í‚¹ ì¡°íšŒë¥¼ ìš”ì²­í•˜ë©´, `allRank` ë©”ì„œë“œê°€ ì‹¤í–‰ë©ë‹ˆë‹¤. ì´ ë©”ì„œë“œëŠ” DB ì ‘ê·¼ ì—†ì´ **ì˜¤ì§ Redisì— ë¯¸ë¦¬ ê³„ì‚°ëœ ë‘ ê°œì˜ Sorted Set ë°ì´í„°ë§Œì„ ì¡°í•©**í•˜ì—¬ ìµœì¢… ì‘ë‹µì„ ìƒì„±í•˜ë¯€ë¡œ ë§¤ìš° ë¹ ë¥¸ ì‘ë‹µ ì†ë„ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤.

1. **`memberRank` ZSET ì¡°íšŒ**: `(memberId: ROI)` ë§µì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
2. **`memberScore` ZSET ì¡°íšŒ**: `(ROI: rank)` ë§µì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
3. ë‘ ë§µì„ ì¡°í•©í•˜ì—¬ ê° `memberId`ì— í•´ë‹¹í•˜ëŠ” `rank`ì™€ `ROI`, ê·¸ë¦¬ê³  `nickname` ì •ë³´ë¥¼ í•©ì³ ìµœì¢… ì‘ë‹µ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

> â–¶ï¸ ê´€ë ¨ ì½”ë“œ ë³´ê¸° (RankService.java)
> 

```java
public RankResponse allRank(){
				// 1. Redisì—ì„œ ë©¤ë²„ë³„ ìˆ˜ìµë¥  ì ìˆ˜ ì¡°íšŒ
        Map<Long,Double> ranks=redisService.getAllMembersWithScores();
        // 2. Redisì—ì„œ ìˆ˜ìµë¥  ì ìˆ˜ë³„ ë“±ìˆ˜ ì¡°íšŒ
        Map<Double,Integer> scores=redisService.getAllRoiWithScores();
        Map<String,Double> result=new LinkedHashMap<>();
        for (Map.Entry<Long, Double> entry : ranks.entrySet()) {
            Long memberId = entry.getKey();
            Double score = entry.getValue();
            Integer memberScore=scores.get(score);

            String memberNickname=memberService.findById(memberId).getNickname();
            String key=memberScore+":"+memberNickname;
            result.put(key,score);
        }

        return new RankResponse(redisService.getRankTime(), result);
    }
```

---

## ğŸ’¡ íšŒê³  ë° ê°œì„  ë°©í–¥

- **ë°°ìš´ ì **: ëŒ€ìš©ëŸ‰ ë°ì´í„°ì˜ ìˆœìœ„ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ë¬¸ì œì—ì„œ ì™œ Redis Sorted Setì´ ê°•ë ¥í•œ ë„êµ¬ì¸ì§€ ì²´ê°í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ë˜í•œ, ë¬´ì‹¬ì½” ì‘ì„±í•œ ë£¨í”„ ë‚´ì˜ API í˜¸ì¶œì´ ì–¼ë§ˆë‚˜ í° ì„±ëŠ¥ ì €í•˜ë¥¼ ì¼ìœ¼í‚¤ëŠ”ì§€, ê·¸ë¦¬ê³  ì´ë¥¼ ì–´ë–»ê²Œ ìµœì í™”í•  ìˆ˜ ìˆëŠ”ì§€ì— ëŒ€í•œ ì¤‘ìš”í•œ ê²½í—˜ì„ ì–»ì—ˆìŠµë‹ˆë‹¤.
- **ê°œì„  ë°©í–¥**:
    - **ë°ì´í„° ì •í•©ì„± ê°•í™”**: í˜„ì¬ ë­í‚¹ ì—…ë°ì´íŠ¸ëŠ” `makeRank`ì™€ `dealSameScore` ë‘ ë‹¨ê³„ë¡œ ë‚˜ë‰˜ì–´ ìˆì–´, ê·¸ ì‚¬ì´ì— ì¡°íšŒ ìš”ì²­ì´ ë“¤ì–´ì˜¬ ê²½ìš° ë¶ˆì™„ì „í•œ ë°ì´í„°ê°€ ë…¸ì¶œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Redisì˜ `RENAME` ëª…ë ¹ì–´ë¥¼ í™œìš©í•˜ì—¬ **ì„ì‹œ í‚¤ì—ì„œ ëª¨ë“  ê³„ì‚°ì„ ì™„ë£Œí•œ ë’¤, í•œ ë²ˆì— ì‹¤ì œ í‚¤ë¡œ ì›ìì ìœ¼ë¡œ(Atomically) ì „í™˜**í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ê°œì„ í•˜ì—¬ ë°ì´í„° ì •í•©ì„±ì„ 100% ë³´ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
